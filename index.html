<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ’­å®¢é‡‘å¥æçº¯åŠ©æ‰‹</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({ startOnLoad: true, theme: 'base', themeVariables: { 'primaryColor': '#E9D5FF' } });
    }
  </script>
  <style>
    :root {
      --paper: #f5f0e6;
      --paper-shadow: #e8e0d0;
      --ink: #2c2c2c;
      --ink-soft: #4a4a4a;
      --accent: #8b6914;
      --card-bg: rgba(255, 252, 245, 0.9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--paper);
      background-image:
        radial-gradient(ellipse at 20% 30%, rgba(230, 220, 200, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(210, 195, 170, 0.3) 0%, transparent 50%);
      color: var(--ink);
      font-family: "Noto Serif SC", "Source Han Serif SC", serif;
      font-size: 16px;
      line-height: 1.75;
      padding: 1.5rem;
    }

    h1 {
      font-family: "ZCOOL XiaoWei", "Noto Serif SC", serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--ink);
      margin: 0 0 1.25rem 0;
      text-align: center;
      letter-spacing: 0.08em;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 2px 12px var(--paper-shadow);
      border: 1px solid rgba(180, 170, 150, 0.25);
    }

    .panel h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 2px solid rgba(139, 105, 20, 0.25);
      letter-spacing: 0.05em;
    }

    .notes-box {
      min-height: 280px;
      width: 100%;
      padding: 1rem;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--ink);
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(180, 170, 150, 0.4);
      border-radius: 8px;
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .notes-box:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(139, 105, 20, 0.15);
    }

    .notes-box::placeholder {
      color: var(--ink-soft);
      opacity: 0.7;
    }

    .outline-content {
      color: var(--ink);
      font-size: 0.95rem;
      line-height: 1.8;
      min-height: 120px;
    }

    .outline-content .outline-placeholder {
      color: var(--ink-soft);
      opacity: 0.8;
      margin: 0;
    }

    /* é«˜çº§ç¬”è®°å¡ç‰‡é£ï¼šæ¯æ¡å¤§çº²ç‹¬ç«‹å¡ç‰‡ï¼ŒåŠ å¤§é—´è·å¢åŠ å‘¼å¸æ„Ÿ */
    .outline-content .outline-cards {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .outline-content .outline-card {
      background: rgba(255, 252, 245, 0.95);
      border-radius: 12px;
      padding: 1.15rem 1.25rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(180, 170, 150, 0.2);
      line-height: 1.8;
    }

    .outline-content .outline-card > .core-line {
      margin-bottom: 0.5rem;
    }

    .outline-content .outline-card > div + div {
      margin-top: 0.4rem;
    }

    .outline-content .outline-card + .outline-card {
      margin-top: 0;
    }

    /* AI æ´å¯Ÿå°æ ‡ç­¾ */
    .outline-content .insight-tag {
      display: inline-block;
      font-size: 0.75rem;
      color: #5c4a7a;
      background: rgba(180, 160, 220, 0.25);
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    .outline-content .insight-tag::before {
      content: 'AI æ´å¯Ÿ Â· ';
      opacity: 0.9;
    }

    /* æ ¸å¿ƒè§‚ç‚¹åŠ ç²—å¹¶ç•¥æ”¾å¤§ */
    .outline-content .outline-card .core-line,
    .outline-content .outline-card strong {
      color: var(--accent);
      font-weight: 600;
      font-size: 1.02em;
    }

    .outline-content .outline-card ul {
      margin: 0.6rem 0 0 0;
      padding-left: 1.35rem;
      list-style-type: disc;
    }

    .outline-content .outline-card ul ul {
      padding-left: 1.2rem;
      margin: 0.25rem 0 0 0;
      list-style-type: circle;
    }

    .outline-content .outline-card li {
      margin-bottom: 0.4rem;
      line-height: 1.7;
    }

    .outline-content .outline-card li:last-child {
      margin-bottom: 0;
    }

    .outline-content p {
      margin: 0.5rem 0 0.75rem 0;
    }

    .outline-content strong {
      color: var(--accent);
      font-weight: 600;
    }

    .outline-content .outline-list {
      padding-left: 0;
      list-style: none;
      margin: 0;
    }

    .outline-content.is-loading {
      color: var(--ink-soft);
      opacity: 0.9;
    }

    /* å›¾è¡¨åŒºåŸŸï¼šé«˜çº§ç¬”è®°å¡ç‰‡é£ï¼Œä¸å¤§çº²ç»Ÿä¸€é…è‰² */
    .chart-container.note-card {
      background: rgba(255, 252, 245, 0.95);
      border-radius: 12px;
      padding: 1.15rem 1.25rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(180, 170, 150, 0.2);
      margin-bottom: 1.25rem;
    }
    .chart-container .mermaid-wrap {
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chart-container .mermaid-wrap svg {
      max-width: 100%;
    }

    .opening-section {
      grid-column: 1 / -1;
      margin-top: 0.5rem;
    }

    .opening-section .opening-text {
      margin: 0;
      padding: 1.25rem 1.5rem;
      font-size: 1.05rem;
      line-height: 2;
      color: var(--ink);
      background: rgba(255, 252, 245, 0.95);
      border-radius: 8px;
      border: 1px solid rgba(180, 170, 150, 0.3);
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      font-family: "Noto Serif SC", "Source Han Serif SC", serif;
      letter-spacing: 0.02em;
      max-width: 100%;
    }

    .opening-text .highlight {
      color: var(--accent);
      font-weight: 600;
    }

    /* ADHD ä¸“æ³¨æ¨¡å¼ï¼šéšè—èƒŒæ™¯è£…é¥° */
    body.focus-mode {
      background: #fafafa;
      background-image: none;
    }
    body.focus-mode .panel {
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border-color: rgba(0,0,0,0.08);
    }
    body.focus-mode .opening-section,
    body.focus-mode .panel:not(.notes-panel) {
      opacity: 0.6;
    }
    body.focus-mode .notes-panel {
      opacity: 1;
    }
    body.focus-mode .notes-editor-wrap {
      background: #fff;
      border-color: rgba(0,0,0,0.12);
    }

    /* å·¦ä¾§å¯å®æ—¶ç¼–è¾‘åŒºåŸŸ */
    .notes-panel .panel-head-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .notes-panel .panel-head-row h2 {
      margin: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .focus-toggle-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--ink-soft);
    }
    .focus-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: rgba(0,0,0,0.12);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .focus-toggle.on {
      background: var(--accent);
    }
    .focus-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .focus-toggle.on::after {
      transform: translateX(20px);
    }

    .notes-editor-wrap {
      position: relative;
      min-height: 280px;
      padding: 1rem;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--ink);
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(180, 170, 150, 0.4);
      border-radius: 8px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .notes-editor-wrap:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(139, 105, 20, 0.15);
    }
    .line-highlight {
      position: absolute;
      left: 0;
      right: 0;
      height: 1.7em;
      background: rgba(139, 105, 20, 0.12);
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: top 0.1s ease-out, opacity 0.15s;
    }
    .notes-editor-wrap.has-caret .line-highlight {
      opacity: 1;
    }
    body.focus-mode .notes-editor-wrap .line-highlight {
      background: rgba(139, 105, 20, 0.22);
    }
    .notes-editor {
      position: relative;
      z-index: 1;
      min-height: 240px;
      outline: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .notes-editor:empty::before {
      content: attr(data-placeholder);
      color: var(--ink-soft);
      opacity: 0.7;
    }

    /* æçº¯æŒ‰é’® */
    .btn-refine-wrap {
      margin-top: 1rem;
      display: flex;
      justify-content: flex-end;
    }
    .btn-refine {
      padding: 0.6rem 1.4rem;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
      letter-spacing: 0.04em;
    }
    .btn-refine:hover:not(:disabled) {
      background: #6d5210;
    }
    .btn-refine:disabled {
      cursor: not-allowed;
      opacity: 0.85;
    }

    /* å¤§çº²åŒºæ·¡å…¥ */
    .outline-content.fade-in {
      animation: outlineFadeIn 0.4s ease-out forwards;
    }
    @keyframes outlineFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* å³ä¾§å¤§çº²åŒºã€Œæ€è€ƒä¸­ã€é—ªçƒ */
    .panel.golden-panel.thinking {
      animation: panelThink 1s ease-in-out;
    }
    @keyframes panelThink {
      0%, 100% { opacity: 1; box-shadow: 0 2px 12px var(--paper-shadow); }
      25% { opacity: 0.6; box-shadow: 0 0 0 2px rgba(139, 105, 20, 0.3); }
      50% { opacity: 1; box-shadow: 0 2px 16px rgba(139, 105, 20, 0.2); }
      75% { opacity: 0.7; box-shadow: 0 0 0 2px rgba(139, 105, 20, 0.25); }
    }
  </style>
</head>
<body>
  <h1>æ’­å®¢é‡‘å¥æçº¯åŠ©æ‰‹</h1>

  <div class="layout">
    <section class="panel notes-panel">
      <div class="panel-head-row">
        <h2>ğŸ“’ åŸå§‹ç¬”è®°</h2>
        <label class="focus-toggle-wrap">
          <span class="focus-toggle" id="focusToggle" role="switch" aria-checked="false" tabindex="0"></span>
          <span>ADHD ä¸“æ³¨æ¨¡å¼</span>
        </label>
      </div>
      <div class="notes-editor-wrap" id="notesWrap">
        <div class="line-highlight" id="lineHighlight"></div>
        <div
          class="notes-editor"
          id="notesEditor"
          contenteditable="true"
          data-placeholder="åœ¨è¿™é‡Œç²˜è´´æˆ–è¾“å…¥ä½ çš„è¯»ä¹¦ç¬”è®°â€¦â€¦"
          spellcheck="true"
        ></div>
      </div>
      <div class="btn-refine-wrap">
        <button type="button" class="btn-refine" id="btnRefine">æçº¯</button>
      </div>
    </section>

    <section class="panel golden-panel right-panel" id="goldenPanel">
      <h2>å†…å®¹å¯è§†åŒ–å¤§çº²</h2>
      <div class="chart-container note-card" id="chartContainer" style="display: none;">
        <div id="mermaid-chart" class="mermaid-wrap"></div>
      </div>
      <div class="outline-content" id="outlineContent">
        <p class="outline-placeholder">ç‚¹å‡»ã€Œæçº¯ã€åï¼ŒAI ä¼šæ ¹æ®å·¦ä¾§æ–‡ç¨¿ç”Ÿæˆé€»è¾‘æ¸…æ™°çš„å¯è§†åŒ–å¤§çº²ï¼ˆæ”¯æŒ Markdown åˆ—è¡¨ä¸å±‚çº§ï¼‰ï¼Œæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
      </div>
    </section>

    <section class="panel opening-section">
      <h2>ğŸ™ï¸ æ’­å®¢å¼€åœºç™½</h2>
      <p class="opening-text" id="openingText" data-placeholder="ç‚¹å‡»ã€Œæçº¯ã€åï¼ŒAI ä¼šæ ¹æ®å·¦ä¾§ç¬”è®°ç”Ÿæˆå¼€åœºç™½ï¼Œæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚">
        å¤§å®¶å¥½ï¼Œä»Šå¤©æƒ³è·Ÿå¤§å®¶èŠä¸€æœ¬ä¹¦ï¼Œå«ã€Šä¸­å›½çš„åä¸ªåå­—ã€‹ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼šä¸­å›½ä¸å°±ä¸€ä¸ªåå­—å—ï¼Ÿå…¶å®ä¸æ˜¯â€”â€”ã€Œä¸­å›½ã€è¿™ä¸ªè¯ï¼Œæœ€æ—©åœ¨é’é“œå™¨ä¸Šå‡ºç°çš„æ—¶å€™ï¼Œå†™çš„å¯æ˜¯ã€Œå®…å…¹ä¸­å›½ã€ï¼Œæ„æ€å¤§æ¦‚æ˜¯ã€Œå°±åœ¨è¿™å„¿ï¼Œå¤©ä¸‹çš„ä¸­å¿ƒã€ã€‚é‚£æ—¶å€™çš„ã€Œä¸­å›½ã€æ›´åƒä¸€ä¸ª<span class="highlight">åœ°å€</span>ï¼Œè¿˜ä¸æ˜¯æˆ‘ä»¬ç°åœ¨çš„å›½åã€‚ä¹¦é‡Œè¿˜æœ‰ç‰¹åˆ«æœ‰æ„æ€çš„ä¸¤ä»¶äº‹ï¼šæ³¢æ–¯äººè€æ—©å°±æŠŠä¸­å›½æƒ³è±¡æˆéåœ°ç¾äººçš„åœ°æ–¹ï¼›è¿˜æœ‰é©¬å¯Â·æ³¢ç½—ï¼Œåœ¨ä¸­å›½å¾…äº†é‚£ä¹ˆä¹…ï¼Œæ¸¸è®°é‡Œå±…ç„¶å‡ ä¹æ²¡æå–èŒ¶ï¼Œè¿™äº‹å„¿åˆ°ç°åœ¨è¿˜æœ‰äººåœ¨åµä»–åˆ°åº•æ¥æ²¡æ¥è¿‡ã€‚æˆ‘ä»¬å°±ä»è¿™å‡ ä¸ªåå­—ã€å‡ æ®µæƒ³è±¡ï¼ŒèŠèŠã€Œä¸­å›½ã€æ˜¯æ€ä¹ˆè¢«å«å‡ºæ¥çš„ï¼Œä»¥åŠåˆ«äººçœ¼é‡Œçš„æˆ‘ä»¬æ˜¯ä»€ä¹ˆæ ·çš„ã€‚
      </p>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    (function () {
      var focusToggle = document.getElementById('focusToggle');
      var notesEditor = document.getElementById('notesEditor');
      var notesWrap = document.getElementById('notesWrap');
      var lineHighlight = document.getElementById('lineHighlight');
      var btnRefine = document.getElementById('btnRefine');
      var outlineContent = document.getElementById('outlineContent');
      var goldenPanel = document.getElementById('goldenPanel');
      var chartContainer = document.getElementById('chartContainer');
      var mermaidChartEl = document.getElementById('mermaid-chart');
      var openingTextEl = document.getElementById('openingText');
      var defaultOpeningHtml = openingTextEl.innerHTML;
      var defaultOutlineHtml = outlineContent.innerHTML;

      function getNotesText() {
        return (notesEditor.innerText || notesEditor.textContent || '').trim();
      }

      function setButtonLoading(loading) {
        btnRefine.disabled = loading;
        btnRefine.textContent = loading ? 'æ­£åœ¨å¤´è„‘é£æš´ä¸­...' : 'æçº¯';
      }

      // å°† API å¯èƒ½è¿”å›çš„å­—é¢é‡ \nã€\rã€\t è½¬ä¸ºçœŸå®æ¢è¡Œ/åˆ¶è¡¨ç¬¦ï¼Œé¿å…é¡µé¢ä¸Šæ˜¾ç¤ºæˆ "\n" ç­‰
      function unescapeLiteralNewlines(s) {
        return String(s)
          .replace(/\\n/g, '\n')
          .replace(/\\r/g, '\r')
          .replace(/\\t/g, '\t');
      }

      function setOpening(str) {
        if (str != null && String(str).trim()) {
          var s = unescapeLiteralNewlines(String(str).trim());
          openingTextEl.textContent = s;
        } else {
          openingTextEl.innerHTML = defaultOpeningHtml;
        }
      }

      function showError(msg) {
        alert(msg);
      }

      // é«˜çº§ç¬”è®°æ„Ÿé…è‰²ï¼šç±³è‰² + æ·¡ç´«è‰²ï¼Œä¸å¡ç‰‡é£æ ¼ä¸€è‡´
      var themeColors = {
        paper: '#f5f0e6',
        ink: '#2c2c2c',
        accent: '#8b6914',
        accentLight: 'rgba(139, 105, 20, 0.15)',
        cardBg: 'rgba(255, 252, 245, 0.95)',
        lavender: '#e8e0f0',
        lavenderBg: 'rgba(180, 160, 220, 0.2)'
      };

      // è‹¥ data.visualCode å­˜åœ¨ï¼Œåœ¨å¤§çº²å¡ç‰‡ä¸Šæ–¹ç”¨ #mermaid-chart å®¹å™¨ + mermaid.run() æ¸²æŸ“ï¼›å¦åˆ™å¹³ç¨³é€€å›é«˜çº§ç¬”è®°å¡ç‰‡æ¨¡å¼
      function renderChartIfPresent(data) {
        if (!chartContainer || !mermaidChartEl) return;
        chartContainer.style.display = 'none';
        mermaidChartEl.innerHTML = '';

        var code = (data && data.visualCode != null) ? String(data.visualCode).trim() : '';
        if (!code || typeof mermaid === 'undefined') {
          return;
        }

        try {
          chartContainer.style.display = 'block';
          mermaidChartEl.innerHTML = '<div class="mermaid">' + code + '</div>';
          mermaid.run({ querySelector: '#mermaid-chart .mermaid', suppressErrors: true }).catch(function () {
            mermaidChartEl.innerHTML = '';
            chartContainer.style.display = 'none';
          });
        } catch (e) {
          mermaidChartEl.innerHTML = '';
          chartContainer.style.display = 'none';
        }
      }

      function setOutlineLoading(loading) {
        if (loading) {
          outlineContent.classList.add('is-loading');
          outlineContent.innerHTML = '<p class="outline-placeholder">æ­£åœ¨ç”Ÿæˆå¤§çº²â€¦</p>';
        } else {
          outlineContent.classList.remove('is-loading');
        }
      }

      // Markdown è½¬ HTMLï¼šä¼˜å…ˆ markedï¼Œå¦åˆ™ç”¨ç®€å•æ­£åˆ™è®©åœ†ç‚¹åˆ—è¡¨æ¼‚äº®æ˜¾ç¤º
      function markdownToHtml(md) {
        var raw = (md || '').trim();
        if (!raw) return '';
        if (typeof marked !== 'undefined') {
          try {
            marked.setOptions({ breaks: true });
            var result = marked.parse(raw);
            return result;
          } catch (e) { /* fallback */ }
        }
        // ç®€å•æ­£åˆ™å…œåº•ï¼š**ç²—ä½“** -> <strong>ï¼Œä»¥ - æˆ– * å¼€å¤´çš„è¡Œ -> <ul><li> åœ†ç‚¹åˆ—è¡¨
        var withStrong = raw.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        if (/\n\s*[-*]\s+/m.test(withStrong)) {
          return '<ul><li>' + withStrong.replace(/\n\s*[-*]\s+/g, '</li><li>') + '</li></ul>';
        }
        return '<p>' + withStrong.replace(/\n/g, '</p><p>') + '</p>';
      }

      // å°†å¤§çº² HTML èµ‹ç»™å³ä¾§ã€Œå†…å®¹å¯è§†åŒ–å¤§çº²ã€åŒºåŸŸï¼Œå¹¶å…³é—­åŠ è½½æç¤º
      function applyOutlineToPanel(html) {
        var el = document.getElementById('outlineContent');
        el.classList.remove('fade-in', 'is-loading');
        el.innerHTML = html;
        el.offsetHeight;
        el.classList.add('fade-in');
        setOutlineLoading(false);
      }

      // æ”¯æŒ Markdownï¼šåŠ ç²— **å…³é”®è¯** ä¸ç¼©è¿›å­åˆ—è¡¨ï¼Œè½¬æˆ HTMLï¼ˆå¹¶åšè½¬ä¹‰é˜² XSSï¼‰
      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }
      function richLineToHtml(line) {
        var parts = line.split(/\*\*(.+?)\*\*/g);
        for (var i = 0; i < parts.length; i++) {
          parts[i] = escapeHtml(parts[i]);
          if (i % 2 === 1) parts[i] = '<strong>' + parts[i] + '</strong>';
        }
        return parts.join('');
      }

      // ä»æ–‡æœ¬ä¸­æå–ã€Œè¯´æ˜ã€ä¸º AI æ´å¯Ÿæ–‡æ¡ˆï¼Œå¹¶ä»æ­£æ–‡ä¸­ç§»é™¤
      function extractInsight(text) {
        var m = text.match(/[ï¼ˆ(]è¯´æ˜[ï¼š:]\s*([^ï¼‰)]+)[ï¼‰)]/);
        if (!m) return { insight: '', main: text };
        var insight = m[1].trim();
        var main = text.replace(/[ï¼ˆ(]è¯´æ˜[ï¼š:]\s*[^ï¼‰)]+[ï¼‰)]/g, '').trim().replace(/\s*\.\s*$/, '').replace(/\s{2,}/g, ' ');
        return { insight: insight, main: main };
      }

      // å•æ¡å†…å®¹è½¬å¡ç‰‡ HTMLï¼šå­åˆ—è¡¨ + åŠ ç²—ï¼Œé¦–è¡Œä½œä¸ºæ ¸å¿ƒå¥ï¼ˆå…ˆç»Ÿä¸€æŠŠå­—é¢é‡ \n è½¬ä¸ºçœŸå®æ¢è¡Œï¼‰
      function buildCardBody(raw) {
        var lines = unescapeLiteralNewlines(String(raw)).split(/\n/);
        var mainParts = [];
        var subParts = [];
        var firstLine = true;
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i];
          if (/^\s+[-*]\s+/.test(line)) {
            subParts.push(line.replace(/^\s+[-*]\s+/, '').trim());
          } else {
            if (subParts.length) {
              mainParts.push('<ul>' + subParts.map(function (s) { return '<li>' + richLineToHtml(s) + '</li>'; }).join('') + '</ul>');
              subParts = [];
            }
            if (line.trim()) {
              var html = richLineToHtml(line.trim());
              if (firstLine) {
                mainParts.push('<div class="core-line">' + html + '</div>');
                firstLine = false;
              } else {
                mainParts.push('<div>' + html + '</div>');
              }
            }
          }
        }
        if (subParts.length) mainParts.push('<ul>' + subParts.map(function (s) { return '<li>' + richLineToHtml(s) + '</li>'; }).join('') + '</ul>');
        return mainParts.join('');
      }

      // ç”¨ data.items å¾ªç¯ç”Ÿæˆã€Œé«˜çº§ç¬”è®°å¡ç‰‡ã€ï¼šæ¯æ¡ç‹¬ç«‹å¡ç‰‡ï¼Œè¯´æ˜â†’AI æ´å¯Ÿæ ‡ç­¾
      function renderOutlineFromItems(items) {
        if (!Array.isArray(items) || items.length === 0) {
          applyOutlineToPanel('<p class="outline-placeholder">æš‚æ— å¤§çº²æ•°æ®ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥è¾“å…¥ã€‚</p>');
          return;
        }
        var cards = items.map(function (item) {
          var raw = typeof item === 'string' ? item : (item && item.text != null ? item.text : String(item));
          var parsed = extractInsight(raw);
          var tagHtml = parsed.insight ? '<span class="insight-tag">' + escapeHtml(parsed.insight) + '</span>' : '';
          var bodyHtml = buildCardBody(parsed.main);
          return '<div class="outline-card">' + tagHtml + bodyHtml + '</div>';
        }).join('');
        applyOutlineToPanel('<div class="outline-cards">' + cards + '</div>');
      }

      // å½“ API åªè¿”å› outline å­—ç¬¦ä¸²ï¼ˆæ—  itemsï¼‰æ—¶ï¼šè§£æä¸ºåˆ—è¡¨å¹¶æ¸²æŸ“ä¸ºå¡ç‰‡ï¼Œé¿å…æ˜¾ç¤ºã€Œæš‚æ— æ•°æ®ã€
      function renderOutlineFromString(outlineStr) {
        var raw = (outlineStr != null && typeof outlineStr === 'string') ? unescapeLiteralNewlines(outlineStr).trim() : '';
        if (!raw) {
          applyOutlineToPanel('<p class="outline-placeholder">æš‚æ— å¤§çº²æ•°æ®ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥è¾“å…¥ã€‚</p>');
          return;
        }
        // æŒ‰ Markdown åˆ—è¡¨é¡¹æ‹†åˆ†ï¼ˆ- æˆ– * å¼€å¤´çš„è¡Œï¼Œæ”¯æŒè¡Œé¦–ç©ºæ ¼ï¼‰
        var bulletRegex = /\n\s*[-*]\s+/;
        var segments = raw.split(bulletRegex);
        var first = segments[0] ? segments[0].trim() : '';
        // è‹¥é¦–æ®µä¸æ˜¯åˆ—è¡¨é¡¹ï¼ˆæ²¡æœ‰å‰å¯¼ - *ï¼‰ï¼Œåˆ™æ•´æ®µä½œä¸ºç¬¬ä¸€é¡¹
        if (first && !/^\s*[-*]\s+/.test(raw)) {
          segments = [first].concat(segments.slice(1).filter(function (s) { return s.trim(); }));
        } else {
          segments = segments.filter(function (s) { return s.trim(); });
        }
        if (segments.length === 0) {
          segments = [raw];
        }
        var cards = segments.map(function (segment) {
          var text = segment.replace(/^\s*[-*]\s+/, '').trim();
          var parsed = extractInsight(text || segment);
          var tagHtml = parsed.insight ? '<span class="insight-tag">' + escapeHtml(parsed.insight) + '</span>' : '';
          var bodyHtml = buildCardBody(parsed.main);
          return '<div class="outline-card">' + tagHtml + bodyHtml + '</div>';
        }).join('');
        applyOutlineToPanel('<div class="outline-cards">' + cards + '</div>');
      }

      btnRefine.addEventListener('click', function () {
        var notes = getNotesText();
        if (!notes) {
          showError('äº²çˆ±çš„åˆ¶ä½œäººï¼Œè¯·å…ˆè¾“å…¥çµæ„Ÿ');
          return;
        }

        setButtonLoading(true);
        goldenPanel.classList.add('thinking');
        setOutlineLoading(true);
        openingTextEl.textContent = 'æ­£åœ¨ç”Ÿæˆå¤§çº²å’Œå¼€åœºç™½â€¦â€¦';

        // åŒæºæ—¶ç”¨ç›¸å¯¹è·¯å¾„ï¼›file:// æˆ– origin ä¸º null æ—¶è¯·æ±‚æœ¬åœ° Node åç«¯ï¼Œé¿å… Failed to fetch
        var origin = window.location.origin;
        var isSameOrigin = origin && origin.startsWith('http');
        var apiBase = isSameOrigin ? '' : ('http://localhost:' + (window.PODCAST_API_PORT || '3001'));
        fetch(apiBase + '/api/claude', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes: notes })
        })
          .then(function (res) {
            return res.json().then(function (data) {
              if (!res.ok) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
              return data;
            });
          })
          .then(function (data) {
            goldenPanel.classList.remove('thinking');
            console.log('æ”¶åˆ°çš„å…¨éƒ¨æ•°æ®:', data);
            // å›¾è¡¨åˆ¤æ–­ï¼šè‹¥ä¸ºå›¾è¡¨ä»£ç åˆ™ç”¨ Mermaid/Chart.js æ¸²æŸ“ï¼Œå¦åˆ™æ˜¾ç¤ºæ–‡å­—å¤§çº²
            renderChartIfPresent(data);
            if (Array.isArray(data.items) && data.items.length > 0) {
              renderOutlineFromItems(data.items);
            } else if (data.outline != null && String(data.outline).trim()) {
              renderOutlineFromString(data.outline);
            } else {
              renderOutlineFromItems(null);
            }
            var openingRaw = data.opening != null ? data.opening : (data.summary != null ? data.summary : '');
            setOpening(openingRaw);
          })
          .catch(function (err) {
            goldenPanel.classList.remove('thinking');
            setOutlineLoading(false);
            var msg = err.message || 'æçº¯å¤±è´¥';
            if (err.message === 'Failed to fetch' || err.name === 'TypeError') {
              msg = 'æ— æ³•è¿æ¥ APIã€‚è¯·å…ˆåœ¨ç»ˆç«¯è¿è¡Œ npm startï¼Œå†åœ¨æµè§ˆå™¨æ‰“å¼€ http://localhost:3001 ä½¿ç”¨æœ¬é¡µã€‚';
            }
            showError(msg);
            renderOutlineFromItems(null);
            setOpening('');
          })
          .finally(function () {
            setButtonLoading(false);
          });
      });

      // ADHD ä¸“æ³¨æ¨¡å¼å¼€å…³
      function setFocusMode(on) {
        document.body.classList.toggle('focus-mode', on);
        focusToggle.classList.toggle('on', on);
        focusToggle.setAttribute('aria-checked', on ? 'true' : 'false');
      }
      focusToggle.addEventListener('click', function () {
        setFocusMode(!document.body.classList.contains('focus-mode'));
      });
      focusToggle.addEventListener('keydown', function (e) {
        if (e.key === ' ' || e.key === 'Enter') {
          e.preventDefault();
          setFocusMode(!document.body.classList.contains('focus-mode'));
        }
      });

      // æ ¹æ®å…‰æ ‡ä½ç½®é«˜äº®å½“å‰è¡Œ
      function updateLineHighlight() {
        var sel = window.getSelection();
        if (!sel.rangeCount || !notesWrap.contains(sel.anchorNode)) {
          notesWrap.classList.remove('has-caret');
          return;
        }
        notesWrap.classList.add('has-caret');
        var range = sel.getRangeAt(0).cloneRange();
        range.collapse(true);
        var rect = range.getBoundingClientRect();
        var wrapRect = notesWrap.getBoundingClientRect();
        var lineHeight = 1.7; // ä¸ .notes-editor line-height ä¸€è‡´
        var heightPx = rect.height > 0 ? rect.height : (getComputedStyle(notesEditor).fontSize.slice(0, -2) * lineHeight);
        lineHighlight.style.top = (rect.top - wrapRect.top + notesWrap.scrollTop) + 'px';
        lineHighlight.style.height = heightPx + 'px';
      }

      notesEditor.addEventListener('input', updateLineHighlight);
      notesEditor.addEventListener('click', updateLineHighlight);
      notesEditor.addEventListener('keyup', updateLineHighlight);
      notesEditor.addEventListener('focus', updateLineHighlight);
      notesWrap.addEventListener('scroll', updateLineHighlight);
      document.addEventListener('selectionchange', function () {
        if (notesEditor.contains(window.getSelection().anchorNode)) updateLineHighlight();
      });
    })();
  </script>
</body>
</html>
